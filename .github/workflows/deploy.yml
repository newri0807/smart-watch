name: Deploy C#
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: SSH Remote Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_NAME }}
        key: ${{ secrets.SERVER_ACCESS_KEY }}
        script: |
          echo "ğŸš€ C# (SmartWatch) ë°°í¬ ì‹œì‘..."
          
          # 1. ê¸°ì¡´ ë ˆí¬ ì‚­ì œ ë° ìµœì‹  ì†ŒìŠ¤ í´ë¡ 
          sudo rm -rf /home/ubuntu/deploy/repo-smartwatch || true
          cd /home/ubuntu/deploy
          git clone -b main https://github.com/newri0807/smart-watch.git repo-smartwatch
          
          # 2. appsettings.json íŒŒì¼ì´ ìˆëŠ” í´ë”ë¡œ ì´ë™
          cd /home/ubuntu/deploy/repo-smartwatch
          
          # 3. appsettings.jsonì˜ ApiKey ê°’ì„ GitHub Secretìœ¼ë¡œ ì¹˜í™˜
          # "ApiKey": "ê°’" í˜•íƒœë¥¼ ì°¾ì•„ì„œ "ApiKey": "ì‹¤ì œí‚¤"ë¡œ ë°”ê¿‰ë‹ˆë‹¤.
          sed -i '/"Weather":/,/"ApiKey":/ s/"ApiKey":\s*".*"/"ApiKey": "${{ secrets.SMARTWATCH_API_KEY }}"/' appsettings.json      
  
          # 4. ì¹˜í™˜ ê²°ê³¼ ì‚´ì§ í™•ì¸ (ë³´ì•ˆìƒ ì•ë¶€ë¶„ë§Œ)
          echo "ğŸ” appsettings.json ApiKey ì ìš© í™•ì¸:"
          grep "ApiKey" appsettings.json | cut -c1-30
          
          # 5. docker-compose.ymlì´ ìˆëŠ” ìƒìœ„ í´ë”ë¡œ ì´ë™ í›„ ì‹¤í–‰
          cd /home/ubuntu/deploy
          docker compose up -d --build smart-watch
          
          echo "âœ… C# ë°°í¬ ì™„ë£Œ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì„±ê³µ!"
        
      
