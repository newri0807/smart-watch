name: Deploy C#
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: SSH Remote Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_NAME }}
        key: ${{ secrets.SERVER_ACCESS_KEY }}
        script: |
          echo "ğŸš€ C# (SmartWatch) 'í´ë¦°' ë°°í¬ ì‹œì‘..."
          
          # 1. ê¸°ì¡´ í´ë”ê°€ ìˆìœ¼ë©´ ê³¼ê°í•˜ê²Œ ì‚­ì œ (ê¶Œí•œ ë¬¸ì œ/ì¶©ëŒ ë°©ì§€)
          if [ -d "~/deploy/repo-smartwatch" ]; then
            sudo rm -rf ~/deploy/repo-smartwatch
          fi
          
          # 2. ê¹¨ë—í•œ ìƒíƒœì—ì„œ ìƒˆë¡œ ë‹¤ìš´ë¡œë“œ
          cd ~/deploy
          git clone https://github.com/newri0807/smart-watch.git repo-smartwatch
          
          # 3. .env ì„¤ì • (ê¸°ì¡´ DB ì„¤ì •ì€ ê±´ë“œë¦¬ì§€ ì•Šê³ , API KEYë§Œ ê°±ì‹ )
          # SMARTWATCH_API_KEY ì¤„ì´ ìˆìœ¼ë©´ ì§€ìš°ê³ , ë§¨ ë’¤ì— ìƒˆë¡œ ì¶”ê°€
          sed -i '/SMARTWATCH_API_KEY/d' .env
          echo "SMARTWATCH_API_KEY=${{ secrets.SMARTWATCH_API_KEY }}" >> .env
          
          # 4. ë„ì»¤ ì‹¤í–‰
          docker compose up -d --build smart-watch
          
          echo "âœ… C# ë°°í¬ ì™„ë£Œ!"
