name: Deploy C#
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: SSH Remote Commands
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_NAME }}
        key: ${{ secrets.SERVER_ACCESS_KEY }}
        script: |
            echo "🚀 C# (SmartWatch) '클린' 배포 시작..."
            
            # 1. 기존 레포 삭제 및 클론
            sudo rm -rf /home/ubuntu/deploy/repo-smartwatch || true
            cd /home/ubuntu/deploy
            git clone -b main https://github.com/newri0807/smart-watch.git repo-smartwatch
            
            # 2. .env 파일 안전하게 생성/수정
            # 파일이 없으면 만들고, 있으면 해당 키만 교체하는 로직
            touch .env
            sed -i '/^SMARTWATCH_API_KEY=/d' .env
            echo "SMARTWATCH_API_KEY=${{ secrets.SMARTWATCH_API_KEY }}" >> .env
            
            # 3. docker-compose.yml이 있는 위치로 확실히 이동
            cd /home/ubuntu/deploy
            
            # 4. 도커 실행 전 변수 확인 
            echo "🔎 .env 파일 내 변수 존재 확인:"
            grep "SMARTWATCH_API_KEY" .env || echo "⚠️ 변수가 설정되지 않았습니다!"
            
            # 5. 도커 실행
            docker compose up -d --build smart-watch
            
            echo "✅ C# 배포 완료!"

        
      
